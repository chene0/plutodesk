name: Desktop Build

on:
    push:
        branches: [main]
        paths:
            - "frontend/src-tauri/**"
            - "frontend/**"
    workflow_dispatch: {}

jobs:
    frontend-desktop:
        runs-on: windows-latest
        defaults:
            run:
                working-directory: frontend
                shell: bash
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
              with:
                  workspaces: frontend/src-tauri
            - run: choco install nsis -y
            - run: npm ci
            - name: Build web
              env: { NEXT_TELEMETRY_DISABLED: 1 }
              run: npm run build
            - name: Build Tauri (NSIS)
              env: { CI: true }
              run: npm run tauri:build -- --bundles nsis
            - uses: actions/upload-artifact@v4
              if: success()
              with:
                  name: desktop-bundles
                  path: frontend/src-tauri/target/release/bundle/**
                  if-no-files-found: ignore
                  retention-days: 7
